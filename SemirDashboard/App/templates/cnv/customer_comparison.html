{% extends 'base.html' %}
{% block title %}Customer Analytics{% endblock %}

{% block extra_css %}
<style>
.stat-card { min-height:130px; border-radius:10px; }
.stat-card .card-body { display:flex; flex-direction:column; justify-content:space-between; }
.stat-value { font-size:1.65rem; font-weight:700; margin:5px 0; }
.stat-label { font-size:.74rem; text-transform:uppercase; letter-spacing:.5px; }

.table-wrapper {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,.08);
    margin-bottom: 1rem;
}
.table-header {
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.table-header h6 { margin:0; font-weight:600; color:#212529; }
.expand-btn {
    background: white;
    border: 1px solid #dee2e6;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.875rem;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
}
.table-scroll { max-height:400px; overflow-y:auto; }

/* Sticky header */
.table-scroll thead th {
    position: sticky; top:0; z-index:2;
    background-color: #2c3e50 !important;
    color: #e2e8f0 !important;
    box-shadow: inset 0 -2px 0 rgba(255,255,255,.15);
    font-weight:600; letter-spacing:.03em;
}

.table-wrapper table { table-layout:fixed; width:100%; }
.table-wrapper th, .table-wrapper td { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* POS table — 7 cols */
.pos-table th:nth-child(1), .pos-table td:nth-child(1) { width:10%; }
.pos-table th:nth-child(2), .pos-table td:nth-child(2) { width:15%; }
.pos-table th:nth-child(3), .pos-table td:nth-child(3) { width:15%; }
.pos-table th:nth-child(4), .pos-table td:nth-child(4) { width:15%; }
.pos-table th:nth-child(5), .pos-table td:nth-child(5) { width:15%; }
.pos-table th:nth-child(6), .pos-table td:nth-child(6) { width:15%; }
.pos-table th:nth-child(7), .pos-table td:nth-child(7) { width:15%; }

/* CNV table — 9 cols */
.cnv-table th:nth-child(1), .cnv-table td:nth-child(1) { width:10%; }
.cnv-table th:nth-child(2), .cnv-table td:nth-child(2) { width:15%; }
.cnv-table th:nth-child(3), .cnv-table td:nth-child(3) { width:15%; }
.cnv-table th:nth-child(4), .cnv-table td:nth-child(4) { width:15%; }
.cnv-table th:nth-child(5), .cnv-table td:nth-child(5) { width:15%; }
.cnv-table th:nth-child(6), .cnv-table td:nth-child(6) { width:15%; }
.cnv-table th:nth-child(7), .cnv-table td:nth-child(7) { width:5%; }
.cnv-table th:nth-child(8), .cnv-table td:nth-child(8) { width:5%; }
.cnv-table th:nth-child(9), .cnv-table td:nth-child(9) { width:5%; }

/* Mismatch table — 12 cols */
.mismatch-table th:nth-child(1),  .mismatch-table td:nth-child(1)  { width:11%; }
.mismatch-table th:nth-child(2),  .mismatch-table td:nth-child(2)  { width:8%; }
.mismatch-table th:nth-child(3),  .mismatch-table td:nth-child(3)  { width:10%; }
.mismatch-table th:nth-child(4),  .mismatch-table td:nth-child(4)  { width:8%; }
.mismatch-table th:nth-child(5),  .mismatch-table td:nth-child(5)  { width:8%; }
.mismatch-table th:nth-child(6),  .mismatch-table td:nth-child(6)  { width:8%; }
.mismatch-table th:nth-child(7),  .mismatch-table td:nth-child(7)  { width:10%; }
.mismatch-table th:nth-child(8),  .mismatch-table td:nth-child(8)  { width:8%; }
.mismatch-table th:nth-child(9),  .mismatch-table td:nth-child(9)  { width:8%; }
.mismatch-table th:nth-child(10), .mismatch-table td:nth-child(10) { width:8%; }
.mismatch-table th:nth-child(11), .mismatch-table td:nth-child(11) { width:8%; }
.mismatch-table th:nth-child(12), .mismatch-table td:nth-child(12) { width:8%; }

/* CNV used-points table — 10 cols (extra In POS col) */
.cnv-used-table th:nth-child(1), .cnv-used-table td:nth-child(1) { width:10%; }
.cnv-used-table th:nth-child(2), .cnv-used-table td:nth-child(2) { width:15%; }
.cnv-used-table th:nth-child(3), .cnv-used-table td:nth-child(3) { width:15%; }
.cnv-used-table th:nth-child(4), .cnv-used-table td:nth-child(4) { width:15%; }
.cnv-used-table th:nth-child(5), .cnv-used-table td:nth-child(5) { width:15%; }
.cnv-used-table th:nth-child(6), .cnv-used-table td:nth-child(6) { width:10%; }
.cnv-used-table th:nth-child(7), .cnv-used-table td:nth-child(7) { width:5%; }
.cnv-used-table th:nth-child(8), .cnv-used-table td:nth-child(8) { width:5%; }
.cnv-used-table th:nth-child(9), .cnv-used-table td:nth-child(9) { width:5%; }
.cnv-used-table th:nth-child(10), .cnv-used-table td:nth-child(10) { width:5%; }

.badge-level-diamond { background-color:#a855f7 !important; color:#fff; }
.badge-level-gold    { background-color:#f59e0b !important; color:#fff; }
.badge-level-silver  { background-color:#94a3b8 !important; color:#fff; }
.badge-level-member  { background-color:#3b82f6 !important; color:#fff; }
.badge-level-vip0    { background-color:#6b7280 !important; color:#fff; }
.badge-level-vip1    { background-color:#3b82f6 !important; color:#fff; }
.badge-level-vip2    { background-color:#f59e0b !important; color:#fff; }
.badge-level-vip3    { background-color:#8b5cf6 !important; color:#fff; }
.badge-level-default { background-color:#6c757d !important; color:#fff; }

.diff-positive { color:#16a34a; font-weight:600; }
.diff-negative { color:#dc2626; font-weight:600; }
.pts-highlight { color:#d97706; font-weight:700; }
</style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-people"></i> Customer Analytics</h2>
    <a href="{% url 'cnv:export_customer_comparison' %}?{% if start_date and end_date %}start_date={{ start_date }}&end_date={{ end_date }}{% endif %}" class="btn btn-success">
        <i class="bi bi-download"></i> Export to Excel
    </a>
</div>

<!-- Date Filter -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" id="dateFilterForm" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar"></i> Start Date</label>
                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar"></i> End Date</label>
                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary me-2"><i class="bi bi-funnel"></i> Apply</button>
                <a href="{% url 'cnv:customer_comparison' %}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Clear</a>
            </div>
        </form>
        <div class="mt-2 pt-2 border-top">
            <small class="text-muted me-2">Quick:</small>
            <div class="btn-group btn-group-sm flex-wrap">
                {% for label, days in quick_btns %}
                <button class="btn btn-outline-secondary quick-days-btn" data-days="{{ days }}">{{ label }}</button>
                {% endfor %}
                <button class="btn btn-outline-secondary" id="btnThisMonth">This Month</button>
                <button class="btn btn-outline-secondary" id="btnLastMonth">Last Month</button>
                <button class="btn btn-outline-secondary" id="btnThisYear">This Year</button>
            </div>
        </div>
        {% if has_filter %}
        <div class="alert alert-info mt-2 mb-0 py-2">
            <i class="bi bi-funnel-fill"></i> Period: <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>
        </div>
        {% endif %}
    </div>
</div>

<!-- ALL-TIME METRICS -->
<p class="text-muted small mb-1 fw-semibold text-uppercase"><i class="bi bi-infinity"></i> All-Time Overview</p>
<div class="row row-cols-2 row-cols-md-4 g-2 mb-3">
    <div class="col"><div class="stat-card card bg-primary bg-gradient text-white border-0"><div class="card-body">
        <div class="stat-label opacity-75">Total Customers (POS System)</div>
        <div class="stat-value">{{ total_pos|default:0 }}</div>
        <small class="opacity-75">From Customer table</small>
    </div></div></div>
    <div class="col"><div class="stat-card card bg-info bg-gradient text-white border-0"><div class="card-body">
        <div class="stat-label opacity-75">Total CNV Customers</div>
        <div class="stat-value">{{ total_cnv|default:0 }}</div>
        <small class="opacity-75">From CNV Customer table</small>
    </div></div></div>
    <div class="col"><div class="stat-card card bg-warning bg-gradient text-dark border-0"><div class="card-body">
        <div class="stat-label">POS Only (Not in CNV)</div>
        <div class="stat-value">{{ pos_only_all_count|default:0 }}</div>
        <small>By phone number</small>
    </div></div></div>
    <div class="col"><div class="stat-card card bg-danger bg-gradient text-white border-0"><div class="card-body">
        <div class="stat-label opacity-75">CNV Only (Not in POS)</div>
        <div class="stat-value">{{ cnv_only_all_count|default:0 }}</div>
        <small class="opacity-75">By phone number</small>
    </div></div></div>
</div>

{% if has_filter %}
<p class="text-muted small mb-1 mt-3 fw-semibold text-uppercase"><i class="bi bi-calendar-range"></i> Period Overview ({{ period_label }})</p>
<div class="row row-cols-2 row-cols-md-4 g-2 mb-3">
    <div class="col"><div class="stat-card card text-white border-0" style="background:#198754"><div class="card-body">
        <div class="stat-label opacity-75">New Customers (POS)</div>
        <div class="stat-value">{{ new_pos_count|default:0 }}</div>
        <small class="opacity-75">Registered in period</small>
    </div></div></div>
    <div class="col"><div class="stat-card card text-white border-0" style="background:#0dcaf0"><div class="card-body">
        <div class="stat-label opacity-75">New CNV Customers</div>
        <div class="stat-value">{{ new_cnv_count|default:0 }}</div>
        <small class="opacity-75">Registered in period</small>
    </div></div></div>
    <div class="col"><div class="stat-card card text-dark border-0" style="background:#ffc107"><div class="card-body">
        <div class="stat-label">New POS Only (Period)</div>
        <div class="stat-value">{{ pos_only_period_count|default:0 }}</div>
        <small>Not in CNV</small>
    </div></div></div>
    <div class="col"><div class="stat-card card text-white border-0" style="background:#dc3545"><div class="card-body">
        <div class="stat-label opacity-75">New CNV Only (Period)</div>
        <div class="stat-value">{{ cnv_only_period_count|default:0 }}</div>
        <small class="opacity-75">Not in POS</small>
    </div></div></div>
</div>
{% endif %}

<div class="row g-3 mt-3">

<div class="col-12">
<div class="table-wrapper">
    <div class="table-header">
        <h6><i class="bi bi-1-circle text-success"></i> CNV Customers with Used Points &gt; 0 ({{ cnv_used_points_count }})</h6>
        <button class="expand-btn" data-bs-toggle="collapse" data-bs-target="#t1"><i class="bi bi-arrows-expand"></i> Show/Hide</button>
    </div>
    <div class="collapse show" id="t1">
        <div class="table-scroll">
            <table class="table table-sm table-hover mb-0 cnv-used-table">
                <thead class="table-dark"><tr>
                    <th>Customer ID</th><th>Phone</th><th>Full Name</th><th>Level</th><th>Email</th><th>Reg Date</th><th>Points</th><th>Used Pts</th><th>Total Pts</th><th>In POS</th>
                </tr></thead>
                <tbody>
                {% for c in cnv_used_points_list %}
                <tr>
                    <td>{{ c.cnv_id }}</td><td>{{ c.phone }}</td>
                    <td>{{ c.last_name|default:'' }} {{ c.first_name|default:'' }}</td>
                    <td>{% with lv=c.level_name|lower %}<span class="badge {% if lv == 'diamond' %}badge-level-diamond{% elif lv == 'gold' %}badge-level-gold{% elif lv == 'silver' %}badge-level-silver{% elif lv == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ c.level_name|default:"-" }}</span>{% endwith %}</td>
                    <td>{{ c.email|default:"-" }}</td>
                    <td>{{ c.cnv_created_at|date:"Y-m-d"|default:"-" }}</td>
                    <td>{{ c.points|default:0 }}</td>
                    <td><strong class="text-success">{{ c.used_points|default:0 }}</strong></td>
                    <td>{{ c.total_points|default:0 }}</td>
                    <td>{% if c.in_pos %}<span class="badge bg-success">✓ Yes</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</td>
                </tr>
                {% empty %}<tr><td colspan="10" class="text-center text-muted py-3">No records found</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
        {% if cnv_used_points_count > 200 %}<div class="p-2 bg-light border-top text-center"><small class="text-muted">Showing first 200 of {{ cnv_used_points_count }} records</small></div>{% endif %}
    </div>
</div>
</div>

<div class="col-12">
<div class="table-wrapper">
    <div class="table-header">
        <h6><i class="bi bi-2-circle text-warning"></i> Points Mismatch — POS Points vs CNV Points ({{ points_mismatch_count }} mismatches)</h6>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary sync-points-btn" data-table="t2" data-url="{% url 'cnv:sync_cnv_points' %}">
                <i class="bi bi-arrow-repeat"></i> Sync CNV Points
            </button>
            <button class="expand-btn" data-bs-toggle="collapse" data-bs-target="#t2"><i class="bi bi-arrows-expand"></i> Show/Hide</button>
        </div>
    </div>
    <div class="collapse show" id="t2">
        <div class="table-scroll">
            <table class="table table-sm table-hover mb-0 mismatch-table">
                <thead class="table-dark"><tr>
                    <th>Phone</th><th>POS VIP ID</th><th>POS Name</th><th>POS Grade</th><th>POS Pts</th>
                    <th>CNV ID</th><th>CNV Name</th><th>CNV Level</th><th>CNV Pts</th><th>Total Pts</th><th>Used Pts</th><th>Diff</th>
                </tr></thead>
                <tbody>
                {% for row in points_mismatch %}
                <tr data-cnv-id="{{ row.cnv_id }}">
                    <td>{{ row.phone }}</td><td>{{ row.pos_vip_id }}</td>
                    <td>{{ row.pos_name|default:"-" }}</td>
                    <td>{% with g=row.pos_grade|lower %}<span class="badge {% if g == 'diamond' %}badge-level-diamond{% elif g == 'vip3' %}badge-level-vip3{% elif g == 'vip2' %}badge-level-vip2{% elif g == 'vip1' %}badge-level-vip1{% elif g == 'vip0' %}badge-level-vip0{% elif g == 'gold' %}badge-level-gold{% elif g == 'silver' %}badge-level-silver{% elif g == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ row.pos_grade|default:"-" }}</span>{% endwith %}</td>
                    <td><span class="pts-highlight">{{ row.pos_points }}</span></td><td>{{ row.cnv_id }}</td>
                    <td>{{ row.cnv_name|default:"-" }}</td>
                    <td>{% with lv=row.cnv_level|lower %}<span class="badge {% if lv == 'diamond' %}badge-level-diamond{% elif lv == 'gold' %}badge-level-gold{% elif lv == 'silver' %}badge-level-silver{% elif lv == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ row.cnv_level|default:"-" }}</span>{% endwith %}</td>
                    <td><span class="pts-highlight">{{ row.cnv_points }}</span></td><td>{{ row.cnv_total_points }}</td><td>{{ row.cnv_used_points }}</td>
                    <td><span class="{% if row.diff > 0 %}diff-positive{% else %}diff-negative{% endif %}">{% if row.diff > 0 %}+{% endif %}{{ row.diff }}</span></td>
                </tr>
                {% empty %}<tr><td colspan="12" class="text-center text-muted py-3">No mismatch found</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
        {% if points_mismatch_count > 100 %}<div class="p-2 bg-light border-top text-center"><small class="text-muted">Showing first 100 of {{ points_mismatch_count }} records</small></div>{% endif %}
    </div>
</div>
</div>

<div class="col-12">
<div class="table-wrapper">
    <div class="table-header">
        <h6><i class="bi bi-3-circle" style="color:#a855f7;"></i> Total Points Mismatch — POS Points vs CNV Total Points ({{ total_points_mismatch_count }} mismatches)</h6>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary sync-points-btn" data-table="t3" data-url="{% url 'cnv:sync_cnv_points' %}">
                <i class="bi bi-arrow-repeat"></i> Sync CNV Points
            </button>
            <button class="expand-btn" data-bs-toggle="collapse" data-bs-target="#t3"><i class="bi bi-arrows-expand"></i> Show/Hide</button>
        </div>
    </div>
    <div class="collapse show" id="t3">
        <div class="table-scroll">
            <table class="table table-sm table-hover mb-0 mismatch-table">
                <thead class="table-dark"><tr>
                    <th>Phone</th><th>POS VIP ID</th><th>POS Name</th><th>POS Grade</th><th>POS Pts</th>
                    <th>CNV ID</th><th>CNV Name</th><th>CNV Level</th><th>CNV Pts</th><th>CNV Total Pts</th><th>Used Pts</th><th>Diff</th>
                </tr></thead>
                <tbody>
                {% for row in total_points_mismatch %}
                <tr data-cnv-id="{{ row.cnv_id }}">
                    <td>{{ row.phone }}</td><td>{{ row.pos_vip_id }}</td>
                    <td>{{ row.pos_name|default:"-" }}</td>
                    <td>{% with g=row.pos_grade|lower %}<span class="badge {% if g == 'diamond' %}badge-level-diamond{% elif g == 'vip3' %}badge-level-vip3{% elif g == 'vip2' %}badge-level-vip2{% elif g == 'vip1' %}badge-level-vip1{% elif g == 'vip0' %}badge-level-vip0{% elif g == 'gold' %}badge-level-gold{% elif g == 'silver' %}badge-level-silver{% elif g == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ row.pos_grade|default:"-" }}</span>{% endwith %}</td>
                    <td><span class="pts-highlight">{{ row.pos_points }}</span></td><td>{{ row.cnv_id }}</td>
                    <td>{{ row.cnv_name|default:"-" }}</td>
                    <td>{% with lv=row.cnv_level|lower %}<span class="badge {% if lv == 'diamond' %}badge-level-diamond{% elif lv == 'gold' %}badge-level-gold{% elif lv == 'silver' %}badge-level-silver{% elif lv == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ row.cnv_level|default:"-" }}</span>{% endwith %}</td>
                    <td>{{ row.cnv_points }}</td>
                    <td><span class="pts-highlight">{{ row.cnv_total_points }}</span></td>
                    <td>{{ row.cnv_used_points }}</td>
                    <td><span class="{% if row.diff > 0 %}diff-positive{% else %}diff-negative{% endif %}">{% if row.diff > 0 %}+{% endif %}{{ row.diff }}</span></td>
                </tr>
                {% empty %}<tr><td colspan="12" class="text-center text-muted py-3">No mismatch found</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
        {% if total_points_mismatch_count > 100 %}<div class="p-2 bg-light border-top text-center"><small class="text-muted">Showing first 100 of {{ total_points_mismatch_count }} records</small></div>{% endif %}
    </div>
</div>
</div>

<div class="col-12">
<div class="table-wrapper">
    <div class="table-header">
        <h6><i class="bi bi-4-circle text-primary"></i> POS Customers NOT in CNV — All Time ({{ pos_only_all_count }})</h6>
        <button class="expand-btn" data-bs-toggle="collapse" data-bs-target="#t4"><i class="bi bi-arrows-expand"></i> Show/Hide</button>
    </div>
    <div class="collapse show" id="t4">
        <div class="table-scroll">
            <table class="table table-sm table-hover mb-0 pos-table">
                <thead class="table-dark"><tr>
                    <th>VIP ID</th><th>Phone</th><th>Name</th><th>VIP Grade</th><th>Email</th><th>Reg Date</th><th>Points</th>
                </tr></thead>
                <tbody>
                {% for c in pos_only_all %}
                <tr>
                    <td>{{ c.vip_id }}</td><td>{{ c.phone }}</td><td>{{ c.name|default:"-" }}</td>
                    <td>{% with g=c.vip_grade|lower %}<span class="badge {% if g == 'diamond' %}badge-level-diamond{% elif g == 'vip3' %}badge-level-vip3{% elif g == 'vip2' %}badge-level-vip2{% elif g == 'vip1' %}badge-level-vip1{% elif g == 'vip0' %}badge-level-vip0{% elif g == 'gold' %}badge-level-gold{% elif g == 'silver' %}badge-level-silver{% elif g == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ c.vip_grade|default:"No Grade" }}</span>{% endwith %}</td>
                    <td>{{ c.email|default:"-" }}</td><td>{{ c.registration_date|date:"Y-m-d"|default:"-" }}</td><td>{{ c.points|default:0 }}</td>
                </tr>
                {% empty %}<tr><td colspan="7" class="text-center text-muted py-3">No records found</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
        {% if pos_only_all_count > 50 %}<div class="p-2 bg-light border-top text-center"><small class="text-muted">Showing first 50 of {{ pos_only_all_count }} records</small></div>{% endif %}
    </div>
</div>
</div>

<div class="col-12">
<div class="table-wrapper">
    <div class="table-header">
        <h6><i class="bi bi-5-circle text-info"></i> CNV Customers NOT in POS — All Time ({{ cnv_only_all_count }})</h6>
        <button class="expand-btn" data-bs-toggle="collapse" data-bs-target="#t5"><i class="bi bi-arrows-expand"></i> Show/Hide</button>
    </div>
    <div class="collapse show" id="t5">
        <div class="table-scroll">
            <table class="table table-sm table-hover mb-0 cnv-table">
                <thead class="table-dark"><tr>
                    <th>Customer ID</th><th>Phone</th><th>Full Name</th><th>Level</th><th>Email</th><th>Reg Date</th><th>Points</th><th>Used Pts</th><th>Total Pts</th>
                </tr></thead>
                <tbody>
                {% for c in cnv_only_all %}
                <tr>
                    <td>{{ c.cnv_id }}</td><td>{{ c.phone }}</td>
                    <td>{{ c.last_name|default:'' }} {{ c.first_name|default:'' }}</td>
                    <td>{% with lv=c.level_name|lower %}<span class="badge {% if lv == 'diamond' %}badge-level-diamond{% elif lv == 'gold' %}badge-level-gold{% elif lv == 'silver' %}badge-level-silver{% elif lv == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ c.level_name|default:"-" }}</span>{% endwith %}</td>
                    <td>{{ c.email|default:"-" }}</td><td>{{ c.cnv_created_at|date:"Y-m-d"|default:"-" }}</td>
                    <td>{{ c.points|default:0 }}</td><td>{{ c.used_points|default:0 }}</td><td>{{ c.total_points|default:0 }}</td>
                </tr>
                {% empty %}<tr><td colspan="9" class="text-center text-muted py-3">No records found</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
        {% if cnv_only_all_count > 50 %}<div class="p-2 bg-light border-top text-center"><small class="text-muted">Showing first 50 of {{ cnv_only_all_count }} records</small></div>{% endif %}
    </div>
</div>
</div>

{% if has_filter %}

<div class="col-12">
<div class="table-wrapper" style="border:2px solid #22c55e;">
    <div class="table-header" style="background:#f0fdf4; border-bottom-color:#22c55e;">
        <h6><i class="bi bi-6-circle text-success"></i> New POS Customers NOT in CNV — Period ({{ pos_only_period_count }})</h6>
        <button class="expand-btn" data-bs-toggle="collapse" data-bs-target="#t6"><i class="bi bi-arrows-expand"></i> Show/Hide</button>
    </div>
    <div class="collapse show" id="t6">
        <div class="table-scroll">
            <table class="table table-sm table-hover mb-0 pos-table">
                <thead class="table-dark"><tr>
                    <th>VIP ID</th><th>Phone</th><th>Name</th><th>VIP Grade</th><th>Email</th><th>Reg Date</th><th>Points</th>
                </tr></thead>
                <tbody>
                {% for c in pos_only_period %}
                <tr>
                    <td>{{ c.vip_id }}</td><td>{{ c.phone }}</td><td>{{ c.name|default:"-" }}</td>
                    <td>{% with g=c.vip_grade|lower %}<span class="badge {% if g == 'diamond' %}badge-level-diamond{% elif g == 'vip3' %}badge-level-vip3{% elif g == 'vip2' %}badge-level-vip2{% elif g == 'vip1' %}badge-level-vip1{% elif g == 'vip0' %}badge-level-vip0{% elif g == 'gold' %}badge-level-gold{% elif g == 'silver' %}badge-level-silver{% elif g == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ c.vip_grade|default:"No Grade" }}</span>{% endwith %}</td>
                    <td>{{ c.email|default:"-" }}</td><td>{{ c.registration_date|date:"Y-m-d"|default:"-" }}</td><td>{{ c.points|default:0 }}</td>
                </tr>
                {% empty %}<tr><td colspan="7" class="text-center text-muted py-3">No records found</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
        {% if pos_only_period_count > 50 %}<div class="p-2 bg-light border-top text-center"><small class="text-muted">Showing first 50 of {{ pos_only_period_count }} records</small></div>{% endif %}
    </div>
</div>
</div>

<div class="col-12">
<div class="table-wrapper" style="border:2px solid #22c55e;">
    <div class="table-header" style="background:#f0fdf4; border-bottom-color:#22c55e;">
        <h6><i class="bi bi-7-circle text-success"></i> New CNV Customers NOT in POS — Period ({{ cnv_only_period_count }})</h6>
        <button class="expand-btn" data-bs-toggle="collapse" data-bs-target="#t7"><i class="bi bi-arrows-expand"></i> Show/Hide</button>
    </div>
    <div class="collapse show" id="t7">
        <div class="table-scroll">
            <table class="table table-sm table-hover mb-0 cnv-table">
                <thead class="table-dark"><tr>
                    <th>Customer ID</th><th>Phone</th><th>Full Name</th><th>Level</th><th>Email</th><th>Reg Date</th><th>Points</th><th>Used Pts</th><th>Total Pts</th>
                </tr></thead>
                <tbody>
                {% for c in cnv_only_period %}
                <tr>
                    <td>{{ c.cnv_id }}</td><td>{{ c.phone }}</td>
                    <td>{{ c.last_name|default:'' }} {{ c.first_name|default:'' }}</td>
                    <td>{% with lv=c.level_name|lower %}<span class="badge {% if lv == 'diamond' %}badge-level-diamond{% elif lv == 'gold' %}badge-level-gold{% elif lv == 'silver' %}badge-level-silver{% elif lv == 'member' %}badge-level-member{% else %}badge-level-default{% endif %}">{{ c.level_name|default:"-" }}</span>{% endwith %}</td>
                    <td>{{ c.email|default:"-" }}</td><td>{{ c.cnv_created_at|date:"Y-m-d"|default:"-" }}</td>
                    <td>{{ c.points|default:0 }}</td><td>{{ c.used_points|default:0 }}</td><td>{{ c.total_points|default:0 }}</td>
                </tr>
                {% empty %}<tr><td colspan="9" class="text-center text-muted py-3">No records found</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
        {% if cnv_only_period_count > 50 %}<div class="p-2 bg-light border-top text-center"><small class="text-muted">Showing first 50 of {{ cnv_only_period_count }} records</small></div>{% endif %}
    </div>
</div>
</div>

{% endif %}
</div><!-- end .row -->
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.quick-days-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const days = parseInt(this.dataset.days);
        const end = new Date(), start = new Date();
        start.setDate(start.getDate() - days);
        document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
        document.querySelector('input[name="end_date"]').value   = end.toISOString().split('T')[0];
        document.getElementById('dateFilterForm').submit();
    });
});
document.getElementById('btnThisMonth')?.addEventListener('click', () => {
    const n = new Date();
    document.querySelector('input[name="start_date"]').value = new Date(n.getFullYear(), n.getMonth(), 1).toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value   = new Date(n.getFullYear(), n.getMonth()+1, 0).toISOString().split('T')[0];
    document.getElementById('dateFilterForm').submit();
});
document.getElementById('btnLastMonth')?.addEventListener('click', () => {
    const n = new Date();
    document.querySelector('input[name="start_date"]').value = new Date(n.getFullYear(), n.getMonth()-1, 1).toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value   = new Date(n.getFullYear(), n.getMonth(), 0).toISOString().split('T')[0];
    document.getElementById('dateFilterForm').submit();
});
document.getElementById('btnThisYear')?.addEventListener('click', () => {
    const n = new Date();
    document.querySelector('input[name="start_date"]').value = new Date(n.getFullYear(), 0, 1).toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value   = new Date(n.getFullYear(), 11, 31).toISOString().split('T')[0];
    document.getElementById('dateFilterForm').submit();
});

// ── Sync CNV Points ──────────────────────────────────────────────
document.querySelectorAll('.sync-points-btn').forEach(btn => {
    btn.addEventListener('click', async function () {
        const tableId = this.dataset.table;
        const url     = this.dataset.url;
        const table   = document.getElementById(tableId);
        if (!table) return;

        // Collect all cnv_ids from rows in this table
        const rows = table.querySelectorAll('tbody tr[data-cnv-id]');
        if (!rows.length) return;

        const cnv_ids = [...rows].map(r => parseInt(r.dataset.cnvId));

        // UI: loading state
        const origHTML = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Syncing...';

        // Mark all rows as pending
        rows.forEach(r => r.style.opacity = '0.5');

        try {
            const csrfToken = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ cnv_ids })
            });
            const data = await resp.json();

            // Build result map
            const resultMap = {};
            (data.results || []).forEach(r => { resultMap[r.cnv_id] = r; });

            // Update each row with fresh data
            rows.forEach(row => {
                const cnvId  = parseInt(row.dataset.cnvId);
                const result = resultMap[cnvId];
                row.style.opacity = '1';

                if (!result || result.status !== 'ok') {
                    row.style.background = '#fff3cd'; // yellow = warning
                    return;
                }

                // T2: cols: phone|pos_vip_id|pos_name|pos_grade|pos_pts|cnv_id|cnv_name|cnv_level|cnv_pts|total_pts|used_pts|diff
                // T3: same layout but col10 = cnv_total_pts
                const cells = row.querySelectorAll('td');
                if (tableId === 't2') {
                    cells[8].innerHTML  = `<span class="pts-highlight">${result.points}</span>`;
                    cells[9].textContent  = result.total_points;
                    cells[10].textContent = result.used_points;
                    // recalc diff = cnv_points - pos_points
                    const posP = parseFloat(cells[4].textContent) || 0;
                    const diff = result.points - posP;
                    cells[11].innerHTML = `<span class="${diff > 0 ? 'diff-positive' : 'diff-negative'}">${diff > 0 ? '+' : ''}${diff}</span>`;
                } else {
                    // t3: cnv_pts col9, cnv_total_pts col10
                    cells[8].textContent  = result.points;
                    cells[9].innerHTML    = `<span class="pts-highlight">${result.total_points}</span>`;
                    cells[10].textContent = result.used_points;
                    // recalc diff = cnv_total_points - pos_points
                    const posP = parseFloat(cells[4].textContent) || 0;
                    const diff = result.total_points - posP;
                    cells[11].innerHTML = `<span class="${diff > 0 ? 'diff-positive' : 'diff-negative'}">${diff > 0 ? '+' : ''}${diff}</span>`;
                }
                row.style.background = '#f0fdf4'; // green = success
            });

            // Count results
            const ok  = (data.results || []).filter(r => r.status === 'ok').length;
            const err = (data.results || []).filter(r => r.status !== 'ok').length;
            this.innerHTML = `<i class="bi bi-check-circle text-success"></i> Synced ${ok}${err ? ` (${err} failed)` : ''}`;
            setTimeout(() => { this.innerHTML = origHTML; this.disabled = false; }, 4000);

        } catch (e) {
            this.innerHTML = '<i class="bi bi-exclamation-circle text-danger"></i> Error';
            rows.forEach(r => r.style.opacity = '1');
            setTimeout(() => { this.innerHTML = origHTML; this.disabled = false; }, 3000);
        }
    });
});
</script>
{% endblock %}