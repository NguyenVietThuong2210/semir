{% extends 'base.html' %}
{% block title %}Customer Analytics{% endblock %}

{% block extra_css %}
<style>
.stat-card { min-height:130px; border-radius:10px; }
.stat-card .card-body { display:flex; flex-direction:column; justify-content:space-between; }
.stat-value { font-size:1.65rem; font-weight:700; margin:5px 0; }
.stat-label { font-size:.74rem; text-transform:uppercase; letter-spacing:.5px; }

.table-wrapper {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,.08);
    margin-bottom: 1rem;
}
.table-header {
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.table-header h6 {
    margin: 0;
    font-weight: 600;
}
.expand-btn {
    background: white;
    border: 1px solid #dee2e6;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.875rem;
    cursor: pointer;
}
.table-scroll {
    max-height: 400px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-people"></i> Customer Analytics</h2>
</div>

<!-- Date Filter -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" id="dateFilterForm" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar"></i> Start Date</label>
                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar"></i> End Date</label>
                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-funnel"></i> Apply
                </button>
                <a href="{% url 'cnv:customer_comparison' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Clear
                </a>
            </div>
        </form>
        <div class="mt-2 pt-2 border-top">
            <small class="text-muted me-2">Quick:</small>
            <div class="btn-group btn-group-sm flex-wrap" id="quickBtnGroup">
                {% for label, days in quick_btns %}
                <button class="btn btn-outline-secondary quick-days-btn" data-days="{{ days }}">{{ label }}</button>
                {% endfor %}
                <button class="btn btn-outline-secondary" id="btnThisMonth">This Month</button>
                <button class="btn btn-outline-secondary" id="btnLastMonth">Last Month</button>
                <button class="btn btn-outline-secondary" id="btnThisYear">This Year</button>
            </div>
        </div>
        {% if has_filter %}
        <div class="alert alert-info mt-2 mb-0 py-2">
            <i class="bi bi-funnel-fill"></i>
            Period: <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>
        </div>
        {% endif %}
    </div>
</div>

<!-- ALL-TIME METRICS -->
<p class="text-muted small mb-1 mt-1 fw-semibold text-uppercase">
    <i class="bi bi-infinity"></i> All-Time Overview
</p>

<div class="row row-cols-2 row-cols-md-4 g-2 mb-3">
    <div class="col">
        <div class="stat-card card bg-primary bg-gradient text-white border-0">
            <div class="card-body">
                <div class="stat-label opacity-75">Total Customers (POS System)</div>
                <div class="stat-value">{{ total_pos|default:0 }}</div>
                <small class="opacity-75">From Customer table</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="stat-card card bg-info bg-gradient text-white border-0">
            <div class="card-body">
                <div class="stat-label opacity-75">Total CNV Customers</div>
                <div class="stat-value">{{ total_cnv|default:0 }}</div>
                <small class="opacity-75">From CNV Customer table</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="stat-card card bg-warning bg-gradient text-dark border-0">
            <div class="card-body">
                <div class="stat-label">POS Only (Not in CNV)</div>
                <div class="stat-value">{{ pos_only_all_count|default:0 }}</div>
                <small>By phone number</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="stat-card card bg-danger bg-gradient text-white border-0">
            <div class="card-body">
                <div class="stat-label opacity-75">CNV Only (Not in POS)</div>
                <div class="stat-value">{{ cnv_only_all_count|default:0 }}</div>
                <small class="opacity-75">By phone number</small>
            </div>
        </div>
    </div>
</div>

<!-- PERIOD METRICS (if filtered) -->
{% if has_filter %}
<p class="text-muted small mb-1 mt-3 fw-semibold text-uppercase">
    <i class="bi bi-calendar-range"></i> Period Overview ({{ period_label }})
</p>

<div class="row row-cols-2 row-cols-md-4 g-2 mb-3">
    <div class="col">
        <div class="stat-card card text-white border-0" style="background:#198754">
            <div class="card-body">
                <div class="stat-label opacity-75">New Customers (POS)</div>
                <div class="stat-value">{{ new_pos_count|default:0 }}</div>
                <small class="opacity-75">Registered in period</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="stat-card card text-white border-0" style="background:#0dcaf0">
            <div class="card-body">
                <div class="stat-label opacity-75">New CNV Customers</div>
                <div class="stat-value">{{ new_cnv_count|default:0 }}</div>
                <small class="opacity-75">Registered in period</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="stat-card card text-dark border-0" style="background:#ffc107">
            <div class="card-body">
                <div class="stat-label">New POS Only (Period)</div>
                <div class="stat-value">{{ pos_only_period_count|default:0 }}</div>
                <small>Not in CNV</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="stat-card card text-white border-0" style="background:#dc3545">
            <div class="card-body">
                <div class="stat-label opacity-75">New CNV Only (Period)</div>
                <div class="stat-value">{{ cnv_only_period_count|default:0 }}</div>
                <small class="opacity-75">Not in POS</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- TABLES SECTION -->
<div class="row g-3 mt-3">
    
    <!-- Table (1): POS Only - All Time -->
    <div class="col-12">
        <div class="table-wrapper">
            <div class="table-header">
                <h6><i class="bi bi-1-circle"></i> POS Customers NOT in CNV - All Time ({{ pos_only_all_count }})</h6>
                <button class="expand-btn" type="button" data-bs-toggle="collapse" data-bs-target="#table1">
                    <i class="bi bi-arrows-expand"></i> Show/Hide
                </button>
            </div>
            <div class="collapse show" id="table1">
                <div class="table-scroll">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>VIP ID</th>
                                <th>Phone</th>
                                <th>Name</th>
                                <th>VIP Grade</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th class="text-end">Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in pos_only_all %}
                            <tr>
                                <td>{{ customer.vip_id }}</td>
                                <td>{{ customer.phone }}</td>
                                <td>{{ customer.name|default:"-" }}</td>
                                <td><span class="badge bg-secondary">{{ customer.vip_grade|default:"No Grade" }}</span></td>
                                <td>{{ customer.email|default:"-" }}</td>
                                <td>{{ customer.registration_date|date:"Y-m-d"|default:"-" }}</td>
                                <td class="text-end">{{ customer.points|default:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center text-muted py-3">No records found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if pos_only_all_count > 50 %}
                <div class="p-2 bg-light border-top text-center">
                    <small class="text-muted">Showing first 50 of {{ pos_only_all_count }} records</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Table (2): CNV Only - All Time -->
    <div class="col-12">
        <div class="table-wrapper">
            <div class="table-header">
                <h6><i class="bi bi-2-circle"></i> CNV Customers NOT in POS - All Time ({{ cnv_only_all_count }})</h6>
                <button class="expand-btn" type="button" data-bs-toggle="collapse" data-bs-target="#table2">
                    <i class="bi bi-arrows-expand"></i> Show/Hide
                </button>
            </div>
            <div class="collapse show" id="table2">
                <div class="table-scroll">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer ID</th>
                                <th>Phone</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th class="text-end">Points Earned</th>
                                <th class="text-end">Points Spent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in cnv_only_all %}
                            <tr>
                                <td>{{ customer.customer_id }}</td>
                                <td>{{ customer.phone }}</td>
                                <td>{{ customer.full_name|default:"-" }}</td>
                                <td>{{ customer.email|default:"-" }}</td>
                                <td>{{ customer.registration_date|date:"Y-m-d"|default:"-" }}</td>
                                <td class="text-end">{{ customer.total_points_earned|default:0 }}</td>
                                <td class="text-end">{{ customer.total_points_spent|default:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center text-muted py-3">No records found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if cnv_only_all_count > 50 %}
                <div class="p-2 bg-light border-top text-center">
                    <small class="text-muted">Showing first 50 of {{ cnv_only_all_count }} records</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Table (3): POS Only - Period -->
    {% if has_filter %}
    <div class="col-12">
        <div class="table-wrapper border-warning" style="border-width: 2px!important;">
            <div class="table-header bg-warning bg-opacity-10">
                <h6><i class="bi bi-3-circle"></i> New POS Customers NOT in CNV - Period ({{ pos_only_period_count }})</h6>
                <button class="expand-btn" type="button" data-bs-toggle="collapse" data-bs-target="#table3">
                    <i class="bi bi-arrows-expand"></i> Show/Hide
                </button>
            </div>
            <div class="collapse show" id="table3">
                <div class="table-scroll">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>VIP ID</th>
                                <th>Phone</th>
                                <th>Name</th>
                                <th>VIP Grade</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th class="text-end">Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in pos_only_period %}
                            <tr>
                                <td>{{ customer.vip_id }}</td>
                                <td>{{ customer.phone }}</td>
                                <td>{{ customer.name|default:"-" }}</td>
                                <td><span class="badge bg-secondary">{{ customer.vip_grade|default:"No Grade" }}</span></td>
                                <td>{{ customer.email|default:"-" }}</td>
                                <td>{{ customer.registration_date|date:"Y-m-d"|default:"-" }}</td>
                                <td class="text-end">{{ customer.points|default:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center text-muted py-3">No records found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if pos_only_period_count > 50 %}
                <div class="p-2 bg-light border-top text-center">
                    <small class="text-muted">Showing first 50 of {{ pos_only_period_count }} records</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Table (4): CNV Only - Period -->
    <div class="col-12">
        <div class="table-wrapper border-danger" style="border-width: 2px!important;">
            <div class="table-header bg-danger bg-opacity-10">
                <h6><i class="bi bi-4-circle"></i> New CNV Customers NOT in POS - Period ({{ cnv_only_period_count }})</h6>
                <button class="expand-btn" type="button" data-bs-toggle="collapse" data-bs-target="#table4">
                    <i class="bi bi-arrows-expand"></i> Show/Hide
                </button>
            </div>
            <div class="collapse show" id="table4">
                <div class="table-scroll">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer ID</th>
                                <th>Phone</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th class="text-end">Points Earned</th>
                                <th class="text-end">Points Spent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in cnv_only_period %}
                            <tr>
                                <td>{{ customer.customer_id }}</td>
                                <td>{{ customer.phone }}</td>
                                <td>{{ customer.full_name|default:"-" }}</td>
                                <td>{{ customer.email|default:"-" }}</td>
                                <td>{{ customer.registration_date|date:"Y-m-d"|default:"-" }}</td>
                                <td class="text-end">{{ customer.total_points_earned|default:0 }}</td>
                                <td class="text-end">{{ customer.total_points_spent|default:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center text-muted py-3">No records found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if cnv_only_period_count > 50 %}
                <div class="p-2 bg-light border-top text-center">
                    <small class="text-muted">Showing first 50 of {{ cnv_only_period_count }} records</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

</div>

{% endblock %}

{% block extra_js %}
<script>
// Quick date buttons (similar to analytics dashboard)
document.querySelectorAll('.quick-days-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const days = parseInt(this.dataset.days);
        const end = new Date();
        const start = new Date();
        start.setDate(start.getDate() - days);
        
        document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
        document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
        document.getElementById('dateFilterForm').submit();
    });
});

document.getElementById('btnThisMonth')?.addEventListener('click', function() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    document.getElementById('dateFilterForm').submit();
});

document.getElementById('btnLastMonth')?.addEventListener('click', function() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const end = new Date(now.getFullYear(), now.getMonth(), 0);
    
    document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    document.getElementById('dateFilterForm').submit();
});

document.getElementById('btnThisYear')?.addEventListener('click', function() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const end = new Date(now.getFullYear(), 11, 31);
    
    document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    document.getElementById('dateFilterForm').submit();
});
</script>
{% endblock %}