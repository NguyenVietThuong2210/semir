{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}Customer Analytics Dashboard{% endblock %}

{% block extra_css %}
<style>
.stat-card { min-height:130px; border-radius:10px; }
.stat-card .card-body { display:flex; flex-direction:column; justify-content:space-between; }
.stat-value { font-size:1.65rem; font-weight:700; margin:5px 0; }
.stat-label { font-size:.74rem; text-transform:uppercase; letter-spacing:.5px; }

.dark-tabs .nav-link {
    background:#2c3e50; color:#bdc3c7;
    border:1px solid #1a252f; border-radius:6px 6px 0 0;
    margin-right:3px; font-weight:500; font-size:.88rem;
}
.dark-tabs .nav-link:hover  { background:#34495e; color:#ecf0f1; }
.dark-tabs .nav-link.active { background:#366092; color:#fff; border-color:#366092; }
.dark-tabs { border-bottom:none; }

td.c-green { background:rgba(25,135,84,.08)!important;  color:#000!important; }
td.c-info  { background:rgba(13,202,240,.09)!important; color:#000!important; }
td.c-blue  { background:rgba(54,96,146,.08)!important;  color:#000!important; }
td.c-gray  { background:#f0f2f5!important;               color:#000!important; }
td.c-amber { background:rgba(255,193,7,.12)!important;   color:#000!important; }

.shop-tbl   { table-layout:fixed; width:100%; }
.shop-tbl   .cn { width:30%; }
.shop-tbl   .cv { width:10%; }

.sub-tbl    { table-layout:fixed; width:100%; font-size:.82rem; }
.sub-tbl    .sl { width:30%; }
.sub-tbl    .sv { width:10%; }
.sub-hdr th { background:#bdd7ee!important; color:#1f3864!important; font-size:.8rem; }
.sub-ses th { background:#d5e8d4!important; color:#1a3d2b!important; font-size:.8rem; }

/* Grade and Season Comparison Tables */
.grade-compare-tbl { table-layout:fixed; width:100%; }
.grade-compare-tbl .shop-col { width:30%; }
.grade-compare-tbl .val-col { width:14%; }

.season-compare-tbl { table-layout:fixed; width:100%; }
.season-compare-tbl .shop-col { width:30%; }
.season-compare-tbl .val-col { width:10%; }

.amount-vnd { white-space:nowrap; font-variant-numeric:tabular-nums; }
.badge.bg-warning { color:#000!important; }
</style>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-bar-chart"></i> Customer Analytics</h2>
    <a href="{% url 'export_analytics' %}{% if start_date and end_date %}?start_date={{ start_date }}&end_date={{ end_date }}{% endif %}"
       class="btn btn-success">
        <i class="bi bi-download"></i> Export to Excel
    </a>
</div>

<!-- Date filter -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" id="dateFilterForm" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar"></i> Start Date</label>
                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar"></i> End Date</label>
                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-funnel"></i> Apply
                </button>
                <a href="{% url 'analytics_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Clear
                </a>
            </div>
        </form>
        <div class="mt-2 pt-2 border-top">
            <small class="text-muted me-2">Quick:</small>
            <div class="btn-group btn-group-sm flex-wrap" id="quickBtnGroup">
                {% for label, days in quick_btns %}
                <button class="btn btn-outline-secondary quick-days-btn" data-days="{{ days }}">{{ label }}</button>
                {% endfor %}
                <button class="btn btn-outline-secondary" id="btnThisMonth">This Month</button>
                <button class="btn btn-outline-secondary" id="btnLastMonth">Last Month</button>
                <button class="btn btn-outline-secondary" id="btnThisYear">This Year</button>
                {% for year in year_btns %}
                <button class="btn btn-outline-secondary quick-year-btn" data-year="{{ year }}">Year {{ year }}</button>
                {% endfor %}
            </div>
        </div>
        {% if start_date and end_date %}
        <div class="alert alert-info mt-2 mb-0 py-2">
            <i class="bi bi-funnel-fill"></i>
            Period: <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>
            {% if session_label %} | Season: <strong>{{ session_label }}</strong>{% endif %}
        </div>
        {% endif %}
    </div>
</div>

<div class="card mb-3 border-0 bg-light">
    <div class="card-body py-2">
        <i class="bi bi-calendar-range text-primary"></i>
        <strong>Data range:</strong>
        {{ date_range.start|date:"d M Y" }} to {{ date_range.end|date:"d M Y" }}
    </div>
</div>

<!-- PERIOD METRICS (8 cards in 2 rows of 4) -->
<p class="text-muted small mb-1 mt-1 fw-semibold text-uppercase">
    <i class="bi bi-calendar-range"></i> Period Metrics
</p>

<!-- Row 1: Customer Metrics -->
<div class="row row-cols-2 row-cols-md-4 g-2 mb-2">
    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(111,66,193,.09)">
            <div class="card-body">
                <div class="stat-label" style="color:#6f42c1">New Members (Period)</div>
                <div class="stat-value" style="color:#6f42c1">{{ overview.new_members_in_period }}</div>
                <small class="text-muted">Registered in period</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(25,135,84,.09)">
            <div class="card-body">
                <div class="stat-label text-success">Returning Customers (Period)</div>
                <div class="stat-value text-success">{{ overview.returning_customers }}</div>
                <small class="text-muted">Came back in period</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(13,202,240,.09)">
            <div class="card-body">
                <div class="stat-label text-info">Active (Period)</div>
                <div class="stat-value text-info">{{ overview.active_customers }}</div>
                <small class="text-muted">Unique customers</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(54,96,146,.09)">
            <div class="card-body">
                <div class="stat-label text-primary">Return Visit Rate (Period)</div>
                <div class="stat-value text-primary">{{ overview.return_rate }}%</div>
                <small class="text-muted">Returning / Active</small>
            </div>
        </div>
    </div>
</div>

<!-- Row 2: Invoice/Amount Metrics -->
<div class="row row-cols-2 row-cols-md-4 g-2 mb-3">
    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(13,110,253,.08)">
            <div class="card-body">
                <div class="stat-label" style="color:#0d6efd">Invoices (Customers)</div>
                <div class="stat-value" style="color:#0d6efd">{{ overview.total_invoices_without_vip0 }}</div>
                <small class="text-muted">Excluding VIP ID = 0</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(255,193,7,.12)">
            <div class="card-body">
                <div class="stat-label" style="color:#856404">Amount (Customers)</div>
                <div class="stat-value amount-vnd" style="color:#856404;font-size:1.1rem">
                    {{ overview.total_amount_without_vip0|vnd }} VND
                </div>
                <small class="text-muted">Excluding VIP ID = 0</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(108,117,125,.1)">
            <div class="card-body">
                <div class="stat-label text-secondary">Total Invoices</div>
                <div class="stat-value text-secondary">{{ overview.total_invoices_with_vip0 }}</div>
                <small class="text-muted">Including all invoices</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(220,53,69,.08)">
            <div class="card-body">
                <div class="stat-label text-danger">Total Amount</div>
                <div class="stat-value amount-vnd text-danger" style="font-size:1.1rem">
                    {{ overview.total_amount_with_vip0|vnd }} VND
                </div>
                <small class="text-muted">Including all amounts</small>
            </div>
        </div>
    </div>
</div>

<!-- ALL-TIME METRICS (4 cards) -->
<p class="text-muted small mb-1 fw-semibold text-uppercase">
    <i class="bi bi-infinity"></i> All-Time Metrics
</p>
<div class="row row-cols-2 row-cols-md-4 g-2 mb-4">

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm bg-light">
            <div class="card-body">
                <div class="stat-label">Total Customers (All Time)</div>
                <div class="stat-value">{{ overview.total_customers_in_db }}</div>
                <small class="text-muted">Registered in DB</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(25,135,84,.07)">
            <div class="card-body">
                <div class="stat-label text-success">Member Active (All Time)</div>
                <div class="stat-value text-success">{{ overview.member_active_all_time }}</div>
                <small class="text-muted">Points &gt; 0</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm bg-light">
            <div class="card-body">
                <div class="stat-label text-secondary">Member Inactive (All Time)</div>
                <div class="stat-value text-secondary">{{ overview.member_inactive_all_time }}</div>
                <small class="text-muted">Points = 0</small>
            </div>
        </div>
    </div>

    <div class="col d-flex">
        <div class="card stat-card w-100 border-0 shadow-sm" style="background:rgba(255,193,7,.14)">
            <div class="card-body">
                <div class="stat-label" style="color:#856404">Return Visit Rate (All Time)</div>
                <div class="stat-value" style="color:#856404">{{ overview.return_rate_all_time }}%</div>
                <small class="text-muted">Returning / Total DB</small>
            </div>
        </div>
    </div>

</div>

<!-- ANALYSIS TABS -->
<div class="card mb-4">
    <div class="card-header p-0 border-0" style="background:#1a252f">
        <ul class="nav dark-tabs px-3 pt-2 flex-wrap" id="analysisTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gradeTab" type="button">
                    <i class="bi bi-star-half"></i> By VIP Grade
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sessionTab" type="button">
                    <i class="bi bi-calendar3"></i> By Season
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#shopTab" type="button">
                    <i class="bi bi-shop"></i> By Shop
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#gradeCompareTab" type="button">
                    <i class="bi bi-award"></i> By Grade - All Shops
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#seasonCompareTab" type="button">
                    <i class="bi bi-calendar3"></i> By Season - All Shops
                </button>
            </li>
        </ul>
    </div>

    <div class="card-body tab-content p-0">

        <!-- BY VIP GRADE TAB -->
        <div class="tab-pane fade show active p-3" id="gradeTab">
            <p class="text-muted small mb-2">
                Grade order: No Grade to Member to Silver to Gold to Diamond.
            </p>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead style="background-color: #366092; color: white;">
                        <tr>
                            <th>VIP Grade</th>
                            <th class="text-end">Returning</th>
                            <th class="text-end">Active (Period)</th>
                            <th class="text-end">Return Visit Rate (Period)</th>
                            <th class="text-end">Total in DB</th>
                            <th class="text-end">Return Rate (All Time)</th>
                            <th class="text-end">Total Invoices</th>
                            <th class="text-end">Total Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for g in grade_stats %}
                        <tr>
                            <td><strong>{{ g.grade }}</strong></td>
                            <td class="text-end">{{ g.returning_customers }}</td>
                            <td class="text-end">{{ g.total_customers }}</td>
                            <td class="text-end">
                                <span class="badge bg-primary">{{ g.return_rate }}%</span>
                            </td>
                            <td class="text-end">{{ g.total_in_db }}</td>
                            <td class="text-end">
                                <span class="badge bg-warning">{{ g.return_rate_all_time }}%</span>
                            </td>
                            <td class="text-end">{{ g.total_invoices }}</td>
                            <td class="text-end amount-vnd">{{ g.total_amount|vnd }} VND</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="8" class="text-center text-muted py-3">No data</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- BY SEASON TAB -->
        <div class="tab-pane fade p-3" id="sessionTab">
            <p class="text-muted small mb-2">
                Year-aware season windows. Returning within a season = customer has at least 1 return visit in that season.
            </p>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead style="background-color: #366092; color: white;">
                        <tr>
                            <th>Season</th>
                            <th class="text-end">Returning</th>
                            <th class="text-end">Active</th>
                            <th class="text-end">Return Rate</th>
                            <th class="text-end">Invoices (Customers)</th>
                            <th class="text-end">Amount (Customers)</th>
                            <th class="text-end">Total Invoices</th>
                            <th class="text-end">Total Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in session_stats %}
                        <tr>
                            <td><strong>{{ s.session }}</strong></td>
                            <td class="text-end">{{ s.returning_customers }}</td>
                            <td class="text-end">{{ s.total_customers }}</td>
                            <td class="text-end">
                                <span class="badge bg-primary">{{ s.return_rate }}%</span>
                            </td>
                            <td class="text-end">{{ s.total_invoices }}</td>
                            <td class="text-end amount-vnd">{{ s.total_amount|vnd }}</td>
                            <td class="text-end">{{ s.total_invoices_with_vip0 }}</td>
                            <td class="text-end amount-vnd">{{ s.total_amount_with_vip0|vnd }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="8" class="text-center text-muted py-3">No season data for this period</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- BY SHOP TAB -->
        <div class="tab-pane fade p-3" id="shopTab">
            <p class="text-muted small mb-2">
                Shops sorted alphabetically. Click a shop row to expand grade and season breakdown.
            </p>
            {% for shop in shop_stats|dictsort:"shop_name" %}
            <div class="card mb-3 border">
                <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center"
                     style="background:#2c3e50;cursor:pointer"
                     data-bs-toggle="collapse"
                     data-bs-target="#shop-{{ forloop.counter }}"
                     aria-expanded="false">
                    <strong class="text-white">{{ shop.shop_name }}</strong>
                    <small class="text-white-50"><i class="bi bi-chevron-down"></i></small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0 shop-tbl">
                            <thead style="background-color: #366092; color: white;">
                                <tr>
                                    <th class="cn">Shop</th>
                                    <th class="cv text-end">Returning</th>
                                    <th class="cv text-end">Active</th>
                                    <th class="cv text-end">Rate</th>
                                    <th class="cv text-end">Invoices (Customers)</th>
                                    <th class="cv text-end">Amount (Customers)</th>
                                    <th class="cv text-end">Total Invoices</th>
                                    <th class="cv text-end">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="cn"><strong>{{ shop.shop_name }}</strong></td>
                                    <td class="cv text-end">{{ shop.returning_customers }}</td>
                                    <td class="cv text-end">{{ shop.total_customers }}</td>
                                    <td class="cv text-end">
                                        <span class="badge bg-primary" style="font-size:.8rem">{{ shop.return_rate }}%</span>
                                    </td>
                                    <td class="cv text-end">{{ shop.total_invoices }}</td>
                                    <td class="cv text-end amount-vnd" style="font-size:.82rem">{{ shop.total_amount|vnd }}</td>
                                    <td class="cv text-end">{{ shop.total_invoices_with_vip0 }}</td>
                                    <td class="cv text-end amount-vnd" style="font-size:.82rem">{{ shop.total_amount_with_vip0|vnd }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="collapse" id="shop-{{ forloop.counter }}">
                        <div class="px-3 py-2 border-top bg-light">
                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <p class="text-muted small fw-semibold mb-1 text-uppercase">By VIP Grade</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle mb-0 sub-tbl">
                                            <thead class="sub-hdr">
                                                <tr>
                                                    <th class="sl">Grade</th>
                                                    <th class="sv text-end">Returning</th>
                                                    <th class="sv text-end">Active</th>
                                                    <th class="sv text-end">Rate</th>
                                                    <th class="sv text-end">Invoices</th>
                                                    <th class="sv text-end">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for gd in shop.by_grade %}
                                                <tr>
                                                    <td class="sl">{{ gd.grade }}</td>
                                                    <td class="sv text-end">{{ gd.returning_customers }}</td>
                                                    <td class="sv text-end">{{ gd.total_customers }}</td>
                                                    <td class="sv text-end">
                                                        <span class="badge bg-primary" style="font-size:.73rem">{{ gd.return_rate }}%</span>
                                                    </td>
                                                    <td class="sv text-end">{{ gd.total_invoices }}</td>
                                                    <td class="sv text-end amount-vnd" style="font-size:.77rem">{{ gd.total_amount|vnd }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="6" class="text-muted small text-center py-1">No data</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <p class="text-muted small fw-semibold mb-1 text-uppercase">By Season</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle mb-0 sub-tbl">
                                            <thead class="sub-ses" style="background-color: #366092; color: white;">
                                                <tr>
                                                    <th class="sl">Season</th>
                                                    <th class="sv text-end">Returning</th>
                                                    <th class="sv text-end">Active</th>
                                                    <th class="sv text-end">Rate</th>
                                                    <th class="sv text-end">Invoices (Customers)</th>
                                                    <th class="sv text-end">Amount (Customers)</th>
                                                    <th class="sv text-end">Total Invoices</th>
                                                    <th class="sv text-end">Total Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for sd in shop.by_session %}
                                                {% if sd.total_customers > 0 %}
                                                <tr>
                                                    <td class="sl">{{ sd.session }}</td>
                                                    <td class="sv text-end">{{ sd.returning_customers }}</td>
                                                    <td class="sv text-end">{{ sd.total_customers }}</td>
                                                    <td class="sv text-end">
                                                        <span class="badge bg-success" style="font-size:.73rem">{{ sd.return_rate }}%</span>
                                                    </td>
                                                    <td class="sv text-end">{{ sd.total_invoices }}</td>
                                                    <td class="sv text-end amount-vnd" style="font-size:.77rem">{{ sd.total_amount|vnd }}</td>
                                                    <td class="sv text-end">{{ sd.total_invoices_with_vip0 }}</td>
                                                    <td class="sv text-end amount-vnd" style="font-size:.77rem">{{ sd.total_amount_with_vip0|vnd }}</td>
                                                </tr>
                                                {% endif %}
                                                {% empty %}
                                                <tr><td colspan="8" class="text-muted small text-center py-1">No data</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center py-3">No shop data available.</p>
            {% endfor %}
        </div>

        <!-- BY GRADE - ALL SHOPS TAB -->
        <div class="tab-pane fade p-3" id="gradeCompareTab">
            <p class="text-muted small mb-2">
                Compare all shops for each VIP grade. Shops sorted alphabetically.
            </p>
            
            {% regroup by_shop|dictsort:"shop_name" by shop_name as shops_list %}
            {% for grade_name in grade_stats %}
            <div class="card mb-3">
                <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center"
                     style="background:#2c3e50;color:white;cursor:pointer"
                     data-bs-toggle="collapse"
                     data-bs-target="#gradeCompare-{{ forloop.counter }}"
                     aria-expanded="false">
                    <strong>GRADE: {{ grade_name.grade }}</strong>
                    <small class="text-white-50"><i class="bi bi-chevron-down"></i></small>
                </div>
                <div class="collapse" id="gradeCompare-{{ forloop.counter }}">
                    <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 grade-compare-tbl">
                            <thead style="background-color: #366092; color: white;">
                                <tr>
                                    <th class="shop-col">Shop</th>
                                    <th class="val-col text-end">Returning</th>
                                    <th class="val-col text-end">Active</th>
                                    <th class="val-col text-end">Return Rate</th>
                                    <th class="val-col text-end">Invoices</th>
                                    <th class="val-col text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for shop in by_shop|dictsort:"shop_name" %}
                                    {% for g in shop.by_grade %}
                                        {% if g.grade == grade_name.grade %}
                                        <tr>
                                            <td class="shop-col"><strong>{{ shop.shop_name }}</strong></td>
                                            <td class="val-col text-end">{{ g.returning_customers }}</td>
                                            <td class="val-col text-end">{{ g.total_customers }}</td>
                                            <td class="val-col text-end">
                                                <span class="badge bg-primary">{{ g.return_rate }}%</span>
                                            </td>
                                            <td class="val-col text-end">{{ g.total_invoices }}</td>
                                            <td class="val-col text-end amount-vnd">{{ g.total_amount|vnd }}</td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- BY SEASON - ALL SHOPS TAB -->
        <div class="tab-pane fade p-3" id="seasonCompareTab">
            <p class="text-muted small mb-2">
                Compare all shops for each season. Shops sorted alphabetically.
            </p>
            
            {% for season_name in session_stats %}
            <div class="card mb-3">
                <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center"
                     style="background:#2c3e50;color:white;cursor:pointer"
                     data-bs-toggle="collapse"
                     data-bs-target="#seasonCompare-{{ forloop.counter }}"
                     aria-expanded="false">
                    <strong>SEASON: {{ season_name.session }}</strong>
                    <small class="text-white-50"><i class="bi bi-chevron-down"></i></small>
                </div>
                <div class="collapse" id="seasonCompare-{{ forloop.counter }}">
                    <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 season-compare-tbl">
                            <thead style="background-color: #366092; color: white;">
                                <tr>
                                    <th class="shop-col">Shop</th>
                                    <th class="val-col text-end">Returning</th>
                                    <th class="val-col text-end">Active</th>
                                    <th class="val-col text-end">Return Rate</th>
                                    <th class="val-col text-end">Invoices (Customers)</th>
                                    <th class="val-col text-end">Amount (Customers)</th>
                                    <th class="val-col text-end">Total Invoices</th>
                                    <th class="val-col text-end">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for shop in by_shop|dictsort:"shop_name" %}
                                    {% for s in shop.by_session %}
                                        {% if s.session == season_name.session %}
                                        <tr>
                                            <td class="shop-col"><strong>{{ shop.shop_name }}</strong></td>
                                            <td class="val-col text-end">{{ s.returning_customers }}</td>
                                            <td class="val-col text-end">{{ s.total_customers }}</td>
                                            <td class="val-col text-end">
                                                <span class="badge bg-primary">{{ s.return_rate }}%</span>
                                            </td>
                                            <td class="val-col text-end">{{ s.total_invoices }}</td>
                                            <td class="val-col text-end amount-vnd">{{ s.total_amount|vnd }}</td>
                                            <td class="val-col text-end">{{ s.total_invoices_with_vip0 }}</td>
                                            <td class="val-col text-end amount-vnd">{{ s.total_amount_with_vip0|vnd }}</td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</div>

<!-- ============================================================================ -->
<!-- BUYER WITHOUT INFO SECTION - Simple blue headers -->
<!-- ============================================================================ -->
<div class="card mb-4">
    <div class="card-header" style="background-color: #366092; color: white;">
        <i class="bi bi-question-circle"></i> Buyer Without Info (VIP ID = 0)
        <span class="badge bg-dark float-end">Excluded from Customer Metrics</span>
    </div>
    <div class="card-body">
        
        <!-- Period and All-Time Summary -->
        <div class="row mb-4">
            <!-- Period Summary -->
            <div class="col-md-6">
                <div class="card border">
                    <div class="card-header" style="background-color: #366092; color: white;">
                        <h6 class="mb-0"><i class="bi bi-calendar-range"></i> Period Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4>{{ buyer_without_info_stats.period.total_invoices|default:0 }}</h4>
                                <small class="text-muted">({{ buyer_without_info_stats.period.pct_of_all_invoices|default:0 }}% of all)</small>
                            </div>
                            <div class="col-6">
                                <h4>{{ buyer_without_info_stats.period.total_amount|default:0|vnd }}</h4>
                                <small class="text-muted">({{ buyer_without_info_stats.period.pct_of_all_amount|default:0 }}% of all)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- All-Time Summary -->
            <div class="col-md-6">
                <div class="card border">
                    <div class="card-header" style="background-color: #366092; color: white;">
                        <h6 class="mb-0"><i class="bi bi-clock-history"></i> All-Time Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4>{{ buyer_without_info_stats.all_time.total_invoices|default:0 }}</h4>
                                <small class="text-muted">Invoices</small>
                            </div>
                            <div class="col-6">
                                <h4>{{ buyer_without_info_stats.all_time.total_amount|default:0|vnd }}</h4>
                                <small class="text-muted">VND</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- By Shop Breakdown -->
        <div class="card">
            <div class="card-header" style="background-color: #366092; color: white;">
                <i class="bi bi-shop"></i> By Shop Breakdown (Period)
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead style="background-color: #366092; color: white;">
                            <tr>
                                <th>Shop</th>
                                <th class="text-end">Invoices</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">% Inv (All Period)</th>
                                <th class="text-end">% Amt (All Period)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shop in buyer_without_info_stats.by_shop %}
                            <tr>
                                <td><strong>{{ shop.shop_name }}</strong></td>
                                <td class="text-end">{{ shop.invoices }}</td>
                                <td class="text-end">{{ shop.amount|vnd }}</td>
                                <td class="text-end">{{ shop.pct_of_period_invoices }}%</td>
                                <td class="text-end">{{ shop.pct_of_period_amount }}%</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="bi bi-info-circle"></i> No anonymous purchases in this period
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-people"></i> Customer Details
        {% if total_detail_count > 100 %}
        <span class="badge bg-info float-end">Top 100 of {{ total_detail_count }}</span>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th>VIP ID</th><th>Name</th><th>Grade</th>
                        <th>Reg. Date</th><th>First Purchase</th>
                        <th class="text-end">Purchases</th>
                        <th class="text-end">Return Visits</th>
                        <th class="text-end">Total Spent</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in customer_details %}
                    <tr>
                        <td><strong>{{ c.vip_id }}</strong></td>
                        <td>{{ c.name }}</td>
                        <td><span class="badge bg-secondary">{{ c.vip_grade|default:"-" }}</span></td>
                        <td>{{ c.registration_date|date:"Y-m-d"|default:"-" }}</td>
                        <td>{{ c.first_purchase_date|date:"Y-m-d"|default:"-" }}</td>
                        <td class="text-end">{{ c.total_purchases }}</td>
                        <td class="text-end">
                            {% if c.return_visits > 0 %}
                            <span class="badge bg-success">{{ c.return_visits }}</span>
                            {% else %}
                            <span class="badge bg-light text-dark border">0</span>
                            {% endif %}
                        </td>
                        <td class="text-end amount-vnd">{{ c.total_spent|floatformat:0 }} VND</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" class="text-center text-muted py-3">No data</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if total_detail_count > 100 %}
        <div class="p-3 text-muted small border-top">
            Showing top 100 by return visits. Export to Excel for all {{ total_detail_count }} records.
        </div>
        {% endif %}
    </div>
</div>

<div class="text-center mb-4">
    <a href="{% url 'home' %}" class="btn btn-outline-secondary page-link">
        <i class="bi bi-arrow-left"></i> Back to Home
    </a>
</div>

{% block extra_js %}
<script>
function _fmt(d) {
    return d.getFullYear() + '-'
        + String(d.getMonth() + 1).padStart(2, '0') + '-'
        + String(d.getDate()).padStart(2, '0');
}
function _submit(s, e) {
    document.querySelector('[name=start_date]').value = s;
    document.querySelector('[name=end_date]').value   = e;
    showLoading('Loading analytics...');
    document.getElementById('dateFilterForm').submit();
}
document.querySelectorAll('.quick-days-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var n = parseInt(this.dataset.days, 10), end = new Date(), start = new Date();
        start.setDate(start.getDate() - n);
        _submit(_fmt(start), _fmt(end));
    });
});
document.getElementById('btnThisMonth').addEventListener('click', function() {
    var n = new Date();
    _submit(_fmt(new Date(n.getFullYear(), n.getMonth(), 1)),
            _fmt(new Date(n.getFullYear(), n.getMonth() + 1, 0)));
});
document.getElementById('btnLastMonth').addEventListener('click', function() {
    var n = new Date();
    _submit(_fmt(new Date(n.getFullYear(), n.getMonth() - 1, 1)),
            _fmt(new Date(n.getFullYear(), n.getMonth(), 0)));
});
document.getElementById('btnThisYear').addEventListener('click', function() {
    var y = new Date().getFullYear();
    _submit(y + '-01-01', y + '-12-31');
});
document.querySelectorAll('.quick-year-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var year = this.dataset.year;
        _submit(year + '-01-01', year + '-12-31');
    });
});
document.getElementById('dateFilterForm').addEventListener('submit', function() {
    showLoading('Loading analytics...');
});
</script>
{% endblock %}
{% endblock %}